---
- name: Test Virtual Esxi Provisioning on Simulator
  tags: integration-ci
  ansible.builtin.include_role:
    name: cloud.vmware_ops.provision_virtual_esxi

- name: Test Virtual Esxi Provisioning on vCenter Env
  tags: eco-vcenter-ci
  block:
  - name: Add Resource Pool
    community.vmware.vmware_resource_pool:
      hostname: "{{ provision_virtual_esxi_hostname }}"
      username: "{{ provision_virtual_esxi_username }}"
      password: "{{ provision_virtual_esxi_password }}"
      datacenter: "{{ provision_virtual_esxi_datacenter }}"
      cluster: "{{ provision_virtual_esxi_cluster }}"
      validate_certs: "{{ provision_virtual_esxi_validate_certs }}"
      resource_pool: "{{ resource_pool_name }}"
      state: present

  - name: Provision Virtual Esxi
    ansible.builtin.import_role:
      name: cloud.vmware_ops.provision_virtual_esxi
    vars:
      provision_virtual_esxi_resource_pool: "{{ resource_pool_name }}"

  - name: Wait until ESXi VM is powered off after OS installation
    community.vmware.vmware_guest_info:
      hostname: "{{ provision_virtual_esxi_hostname }}"
      username: "{{ provision_virtual_esxi_username }}"
      password: "{{ provision_virtual_esxi_password }}"
      port: "{{ provision_virtual_esxi_port }}"
      datacenter: "{{ provision_virtual_esxi_datacenter }}"
      validate_certs: "{{ provision_virtual_esxi_validate_certs }}"
      name: "{{ provision_virtual_esxi_vms[0].name }}"
    register: _esxi_power_status
    until: _esxi_power_status.instance.hw_power_status == 'poweredOff'
    retries: 30
    delay: 20

  - name: Power on ESXi VM if it is off
    ansible.builtin.import_role:
      name: cloud.vmware_ops.provision_vm
    vars:
      provision_vm_hostname: "{{ provision_virtual_esxi_hostname }}"
      provision_vm_username: "{{ provision_virtual_esxi_username }}"
      provision_vm_password: "{{ provision_virtual_esxi_password }}"
      provision_vm_validate_certs: false
      provision_vm_port: "{{ provision_virtual_esxi_port }}"
      provision_vm_cluster: "{{ provision_virtual_esxi_cluster }}"
      provision_vm_datacenter: "{{ provision_virtual_esxi_datacenter }}"
      provision_vm_name: "{{ provision_virtual_esxi_vms[0].name }}"
      provision_vm_state: "poweredon"

  - name: Wait until ESXi VM has an IP address
    community.vmware.vmware_guest_info:
      hostname: "{{ provision_virtual_esxi_hostname }}"
      username: "{{ provision_virtual_esxi_username }}"
      password: "{{ provision_virtual_esxi_password }}"
      port: "{{ provision_virtual_esxi_port }}"
      datacenter: "{{ provision_virtual_esxi_datacenter }}"
      validate_certs: "{{ provision_virtual_esxi_validate_certs }}"
      name: "{{ provision_virtual_esxi_vms[0].name }}"
    register: _esxi_host_check
    until: _esxi_host_check.instance.ipv4 is defined and _esxi_host_check.instance.ipv4 is not none
    retries: 30
    delay: 10

  - name: Set fact for esxi instance
    set_fact:
      esxi_host: "{{ _esxi_host_check }}"

  - name: Check if VM is up
    wait_for:
      host: "{{ esxi_host.instance.ipv4 }}"
      port: 22
      delay: 10
      timeout: 300
      state: started

  always:
    - name: "Call cleanup playbook"
      ansible.builtin.include_tasks: cleanup_esxi.yml
