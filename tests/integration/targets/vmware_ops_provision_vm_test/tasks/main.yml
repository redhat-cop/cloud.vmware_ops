---
- name: Provision VM for simulator
  ansible.builtin.import_role:
    name: cloud.vmware_ops.provision_vm
  tags: integration-ci

- name: Perform VM Lifecycle Operations in vCenter Environment
  block:
  - name: Import common vars
    ansible.builtin.include_vars:
      file: ../group_vars.yml

  - name: Provision multiple VMs
    loop: "{{ provision_vms }}"
    ansible.builtin.include_tasks: provision_vms_with_validation.yml

  - name: Update one the provisioned VMs
    ansible.builtin.include_tasks: update_vm.yml

  always:
    - name: Cleanup VMs and template from the vcenter env
      loop: "{{ provision_vms }}"
      ansible.builtin.include_tasks: cleanup_vms.yml

    - name: Cleanup Network
      community.vmware.vmware_portgroup:
        hostname: "{{ vcenter_hostname }}"
        username: "{{ vcenter_username }}"
        password: "{{ vcenter_password }}"
        validate_certs: "{{ provision_vm_validate_certs }}"
        cluster_name: "{{ provision_vm_cluster }}"
        switch: "{{ vswitch_name }}"
        portgroup: "{{ portgroup_name }}"
        state: absent
  tags: eco-vcenter-ci
